<?php

namespace App\Http\Controllers;

use App\Models\VulnerabilitySubmission;
use App\Models\Vulnerability;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\DB;

class VulnerabilitySubmissionController extends Controller
{
    public function index(Request $request): JsonResponse
    {
        $query = VulnerabilitySubmission::with(['user', 'vulnerabilities']);
        
        // If user is not admin, only show their own submissions
        if (!$request->user()->isAdmin()) {
            $query->where('user_id', $request->user()->id);
        }
        
        // Apply filters
        if ($request->has('status')) {
            $query->where('status', $request->status);
        }
        
        if ($request->has('risk_score')) {
            $query->where('risk_score', '>=', $request->risk_score);
        }
        
        $submissions = $query->orderBy('created_at', 'desc')
                           ->paginate($request->get('per_page', 15));
        
        return response()->json($submissions);
    }

    public function store(Request $request): JsonResponse
    {
        $validated = $request->validate([
            'title' => 'required|string|max:255',
            'vulnerabilities' => 'required|array|min:1',
            'vulnerabilities.*.category' => 'required|string|max:255',
            'vulnerabilities.*.title' => 'required|string|max:255',
            'vulnerabilities.*.description' => 'sometimes|string|nullable',
            'vulnerabilities.*.severity' => 'required|in:low,medium,high',
            'vulnerabilities.*.remediation_steps' => 'sometimes|string|nullable',
        ]);

        return DB::transaction(function () use ($validated, $request) {
            // Create submission
            $submission = VulnerabilitySubmission::create([
                'user_id' => $request->user()->id,
                'title' => $validated['title'],
                'risk_score' => 0, // Will be recalculated after vulnerabilities are created
                'risk_level' => 'low', // Will be updated based on risk_score
                'status' => 'open',
            ]);

            // Create vulnerabilities
            foreach ($validated['vulnerabilities'] as $vulnData) {
                Vulnerability::create([
                    'vulnerability_submission_id' => $submission->id,
                    'category' => $vulnData['category'],
                    'title' => $vulnData['title'],
                    'description' => $vulnData['description'] ?? null,
                    'severity' => $vulnData['severity'],
                    'remediation_steps' => $vulnData['remediation_steps'] ?? null,
                    'is_resolved' => false,
                ]);
            }

            // Recalculate risk score
            $submission->update(['risk_score' => $submission->calculateRiskScore()]);

            return response()->json([
                'submission' => $submission->load(['vulnerabilities', 'user']),
                'message' => 'Vulnerability submission created successfully'
            ], 201);
        });
    }

    public function show(VulnerabilitySubmission $submission): JsonResponse
    {
        // Check if the user owns this submission or is an admin
        if ($submission->user_id !== auth()->id() && !auth()->user()->isAdmin()) {
            return response()->json(['message' => 'Unauthorized'], 403);
        }

        return response()->json($submission->load(['user', 'vulnerabilities']));
    }

    public function update(Request $request, VulnerabilitySubmission $submission): JsonResponse
    {
        // Check permissions
        if ($submission->user_id !== auth()->id() && !auth()->user()->isAdmin()) {
            return response()->json(['message' => 'Unauthorized'], 403);
        }

        $validated = $request->validate([
            'title' => 'sometimes|string|max:255',
            'status' => 'sometimes|in:open,resolved',
            'assigned_to' => 'sometimes|exists:users,id',
            'risk_score' => 'sometimes|numeric|min:0|max:100',
            'risk_level' => 'sometimes|in:low,medium,high',
        ]);

        if (isset($validated['status']) && $validated['status'] === 'resolved') {
            $validated['resolved_at'] = now();
            $submission->vulnerabilities()->where('is_resolved', false)->each(function($vulnerability) {
                $vulnerability->markResolved(auth()->user());
            });
        }

        $submission->update($validated);

        return response()->json([
            'submission' => $submission->load(['vulnerabilities', 'user']),
            'message' => 'Submission updated successfully'
        ]);
    }

    public function destroy(VulnerabilitySubmission $submission): JsonResponse
    {
        // Check permissions
        if ($submission->user_id !== auth()->id() && !auth()->user()->isAdmin()) {
            return response()->json(['message' => 'Unauthorized'], 403);
        }

        $submission->delete();
        return response()->json(['message' => 'Submission deleted successfully']);
    }
}